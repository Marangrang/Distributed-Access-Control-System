name: CD - Build and Deploy Locally

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 90  # Increased timeout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Docker
        shell: powershell
        run: |
          docker version | Out-Host
          if ($LASTEXITCODE -ne 0) { Write-Host "ERROR: Docker not available"; exit 1 }

      - name: Optional pre-clean
        shell: powershell
        run: |
          docker system prune -f
          docker builder prune --filter "until=72h" -f

      - name: Build Docker image with cache
        shell: powershell
        run: |
          Write-Host "=================================================="
          Write-Host "BUILDING DOCKER IMAGE"
          Write-Host "=================================================="
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          
          # Use BuildKit with inline cache
          $env:DOCKER_BUILDKIT = "1"
          docker build `
            --cache-from face-verification-service:latest `
            --build-arg BUILDKIT_INLINE_CACHE=1 `
            -f ./serve/Dockerfile `
            -t face-verification-service:latest `
            -t face-verification-service:$SHORT_SHA `
            .
          
          if ($LASTEXITCODE -ne 0) { Write-Host "ERROR: Docker build failed"; exit 1 }
          Write-Host "SUCCESS: Build completed"

      - name: Deploy Application
        shell: powershell
        run: |
          Write-Host "=================================================="
          Write-Host "DEPLOYING APPLICATION"
          Write-Host "=================================================="

          $repoRoot = "C:\Users\NWUUSER\Documents\deploy SLI\Distributed-Access-Control-System-master"
          Set-Location $repoRoot

          # Check for .env
          if (-Not (Test-Path ".\serve\.env")) {
            Write-Host "ERROR: serve/.env not found"
            exit 1
          }

          # Detect compose command
          $composeCmd = @("docker", "compose")
          docker compose version 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) { $composeCmd = @("docker-compose") }

          Write-Host "Stopping old containers..."
          & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env down -v
          
          Write-Host "Starting new containers..."
          & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env up -d
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: compose up failed"
            & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env logs --tail=300
            exit 1
          }

          Write-Host "Waiting for containers..."
          $healthy = $false
          for ($i=0; $i -lt 30; $i++) {
            $ps = & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env ps 2>&1
            if ($ps -match "Up|running") { $healthy = $true; break }
            Start-Sleep -Seconds 3
          }

          if (-Not $healthy) {
            Write-Host "ERROR: Services not healthy"
            & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env logs --tail=300
            exit 1
          }

          Write-Host "SUCCESS: All containers running"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Collect logs
        if: always()
        shell: powershell
        run: |
          $repoRoot = "C:\Users\NWUUSER\Documents\deploy SLI\Distributed-Access-Control-System-master"
          Set-Location $repoRoot
          
          $composeCmd = @("docker", "compose")
          docker compose version 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) { $composeCmd = @("docker-compose") }
          
          & $composeCmd[0] $composeCmd[1..($composeCmd.Length-1)] --env-file ./serve/.env logs --tail=300 | Out-File -FilePath "$env:RUNNER_TEMP\compose-logs.txt" -Encoding UTF8

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: ${{ runner.temp }}/compose-logs.txt
          if-no-files-found: warn
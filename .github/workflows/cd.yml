name: CD - Build and Deploy Locally

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image locally
        shell: powershell
        run: |
          Write-Host "=================================================="
          Write-Host "üî® BUILDING DOCKER IMAGE"
          Write-Host "=================================================="
          
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          
          Write-Host "Building image with tag: latest and $SHORT_SHA"
          Write-Host ""
          
          docker build -f ./serve/Dockerfile `
            -t face-verification-service:latest `
            -t face-verification-service:$SHORT_SHA `
            .
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Docker build failed"
            exit 1
          }
          
          Write-Host ""
          Write-Host "‚úÖ Build completed successfully"

      - name: Deploy Application
        shell: powershell
        run: |
          Write-Host "=================================================="
          Write-Host "üöÄ DEPLOYING APPLICATION"
          Write-Host "=================================================="
          
          Set-Location "C:\Users\NWUUSER\Documents\deploy SLI\Distributed-Access-Control-System-master"
          
          Write-Host "`nüîÑ Stopping old containers..."
          docker-compose down
          
          Write-Host "`nüöÄ Starting new containers..."
          docker-compose up -d --build
          
          Write-Host "`n‚è≥ Waiting for containers to start..."
          Start-Sleep -Seconds 15
          
          Write-Host "`nüìä Container status:"
          docker-compose ps
          
          Write-Host "`nüîç Checking container health:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          Write-Host "`nüìú Recent logs:"
          docker-compose logs --tail=30
          
          Write-Host "`n=================================================="
          Write-Host "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY"
          Write-Host "=================================================="
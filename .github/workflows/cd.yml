name: CD - Build and Deploy Locally

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Docker Desktop is up
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          docker context use desktop-linux | Out-Null
          $deadline = (Get-Date).AddMinutes(3)
          do {
            Start-Sleep -Seconds 5
            try { docker version | Out-Null; $ok = $true } catch { $ok = $false }
          } while ((-not $ok) -and (Get-Date) -lt $deadline)
          if (-not $ok) { Write-Host 'ERROR: Docker daemon not ready'; exit 1 }

      - name: Verify Docker
        shell: powershell
        run: |
          Write-Host "Docker version:"
          docker version
          Write-Host "`nDocker info:"
          docker info

      - name: Optional pre-clean
        shell: powershell
        continue-on-error: true
        run: |
          docker compose down -v
          docker system prune -f

      - name: Fail if compose file missing
        shell: powershell
        run: |
          if (-not (Test-Path '.\docker-compose.yml')) {
            Write-Host "docker-compose.yml not found"
            exit 1
          }

      - name: Build Docker image with cache
        shell: powershell
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker compose build --progress=plain

      - name: Deploy Application
        shell: powershell
        run: |
          docker compose up -d
          docker compose ps

      - name: Health check
        shell: powershell
        run: |
          $deadline = (Get-Date).AddMinutes(2)
          $ok = $false
          while (-not $ok -and (Get-Date) -lt $deadline) {
            try {
              $res = Invoke-RestMethod -Uri "http://localhost:8080/health" -TimeoutSec 5
              if ($res.status -eq 'ok') { $ok = $true }
            } catch { Start-Sleep -Seconds 5 }
          }
          if (-not $ok) { Write-Host "Health check failed"; docker compose logs; exit 1 }

      - name: Collect logs
        if: always()
        shell: powershell
        run: |
            mkdir -Force logs | Out-Null
            docker compose logs --no-color > logs\compose.log 2>&1
            docker ps -a > logs\ps-a.txt
            docker info > logs\docker-info.txt
            docker compose config > logs\compose-config.txt

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: logs
          retention-days: 7
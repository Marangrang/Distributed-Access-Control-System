name: CD - Build and Deploy Locally

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 240

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Docker is ready
        shell: powershell
        run: |
          $tries=0
          while ($tries -lt 10) {
            docker ps 2>$null
            if ($LASTEXITCODE -eq 0) { Write-Host "[OK] Docker ready"; break }
            $tries++
            Write-Host "Waiting for Docker ($tries/10)..."
            Start-Sleep -Seconds 5
          }
          if ($LASTEXITCODE -ne 0) { Write-Error "Docker not ready"; exit 1 }

      - name: Show Docker versions
        shell: powershell
        run: |
          Write-Host "Docker info:"
          docker version
          docker compose version

      - name: Load environment variables
        shell: powershell
        run: |
          if (Test-Path .env) {
            Get-Content .env | ForEach-Object {
              if ($_ -match '^([^#].+?)=(.+)$') {
                $name = $matches[1].Trim()
                $value = $matches[2].Trim()
                Write-Host "Setting $name"
                [Environment]::SetEnvironmentVariable($name, $value, "Process")
              }
            }
          }

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Stop and remove existing containers
        shell: powershell
        run: |
          Write-Host "Stopping existing containers..."
          docker compose down --remove-orphans --volumes

          # Force-remove any leftover named containers (ignore all errors)
          $ErrorActionPreference = 'SilentlyContinue'
          @("app", "db", "minio") | ForEach-Object {
            docker rm -f $_ 2>&1 | Out-Null
          }
          $ErrorActionPreference = 'Continue'

          Write-Host "[OK] Cleanup complete"
          exit 0

      - name: Restart Docker BuildKit
        shell: powershell
        run: |
          Write-Host "Restarting BuildKit..."
          docker buildx rm --all-inactive --force 2>$null
          docker buildx prune -af 2>$null
          Write-Host "[OK] BuildKit reset"

      - name: Build Docker images
        shell: powershell
        run: |
          Write-Host "Building Docker images..."
          $env:DOCKER_BUILDKIT=1
          $env:COMPOSE_DOCKER_CLI_BUILD=1
          docker compose build
          if ($LASTEXITCODE -ne 0) { Write-Error "Build failed"; exit 1 }
          Write-Host "[OK] Docker images built successfully"

      - name: Check Docker images
        shell: powershell
        run: |
          Write-Host "Docker images:"
          docker images | Select-String "distributed-access-control-system"

          Write-Host "`nDocker compose config (first 50 lines):"
          $config = docker compose config
          $config | Select-Object -First 50

          Write-Host "`nDocker compose ps:"
          docker compose ps

      - name: Start services
        shell: powershell
        run: |
          Write-Host "Starting services..."
          docker compose up -d
          if ($LASTEXITCODE -ne 0) {
            Write-Host "[ERROR] Failed to start services"
            docker compose ps
            docker compose logs --tail=50
            exit 1
          }
          Write-Host "[OK] Services started"

      - name: Wait for services to be healthy
        shell: powershell
        timeout-minutes: 5
        run: |
          Write-Host "Waiting for services to be healthy..."
          $maxAttempts = 30
          $attempt = 0
          $allHealthy = $false

          while (-not $allHealthy -and $attempt -lt $maxAttempts) {
            $attempt++
            Write-Host "Health check attempt $attempt/$maxAttempts..."

            try {
              $services = docker compose ps --format json | ConvertFrom-Json
              $unhealthy = $services | Where-Object {
                $_.Health -ne "healthy" -and $_.State -eq "running"
              }

              if ($unhealthy.Count -eq 0) {
                $allHealthy = $true
                Write-Host "[OK] All services are healthy"
              } else {
                Write-Host "Waiting for: $($unhealthy.Service -join ', ')"
                Start-Sleep -Seconds 5
              }
            } catch {
              Write-Host "Error checking service health, retrying..."
              Start-Sleep -Seconds 5
            }
          }

          if (-not $allHealthy) {
            Write-Host "[ERROR] Services failed to become healthy"
            docker compose ps
            docker compose logs --tail=50
            exit 1
          }

      - name: Smoke Test - Database
        shell: powershell
        run: |
          Write-Host "Testing database connectivity..."
          $dbUser = if ($env:DB_USER) { $env:DB_USER } else { "appuser" }
          $dbName = if ($env:DB_NAME) { $env:DB_NAME } else { "appdb" }

          docker compose exec -T db pg_isready -U $dbUser -d $dbName
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] Database is ready"
          } else {
            Write-Host "[ERROR] Database check failed"
            docker compose logs db --tail=30
            exit 1
          }

      - name: Smoke Test - MinIO
        shell: powershell
        run: |
          Write-Host "Testing MinIO connectivity..."
          try {
            $minio = Invoke-WebRequest -Uri "http://localhost:9000/minio/health/live" -TimeoutSec 5
            if ($minio.StatusCode -eq 200) {
              Write-Host "[OK] MinIO is healthy"
            }
          } catch {
            Write-Host "[ERROR] MinIO health check failed: $_"
            docker compose logs minio --tail=30
            exit 1
          }

      - name: Smoke Test - API (if exists)
        shell: powershell
        continue-on-error: true
        run: |
          $services = docker compose ps --services
          if (-not ($services -contains 'app')) {
            Write-Host "[INFO] No 'app' service found. Skipping API smoke tests."
            exit 0
          }

          $port = if ($env:PORT) { $env:PORT } else { 8000 }
          $url = "http://localhost:$port/health"
          Write-Host "Testing API health endpoint at $url..."
          $max=20; $ok=$false
          for ($i=1; $i -le $max; $i++) {
            try {
              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 3
              if ($resp.StatusCode -eq 200) {
                $ok=$true
                Write-Host "[OK] API is healthy"
                break
              }
            } catch {
              Write-Host "Health check failed, retrying ($i/$max)..."
              Start-Sleep -Seconds 3
            }
          }
          if (-not $ok) {
            Write-Host "[WARNING] API health endpoint not ready"
          }

      - name: Download MinIO Client
        shell: powershell
        run: |
          if (-not (Test-Path "mc.exe")) {
            Write-Host "Downloading MinIO Client..."
            Invoke-WebRequest -Uri "https://dl.min.io/client/mc/release/windows-amd64/mc.exe" -OutFile "mc.exe"
            Write-Host "[OK] MinIO Client downloaded"
          }

      - name: Configure MinIO and create bucket
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Configuring MinIO..."
          $accessKey = if ($env:MINIO_ACCESS_KEY) { $env:MINIO_ACCESS_KEY } else { "minioadmin" }
          $secretKey = if ($env:MINIO_SECRET_KEY) { $env:MINIO_SECRET_KEY } else { "minioadmin" }

          .\mc.exe alias set myminio http://localhost:9000 $accessKey $secretKey
          .\mc.exe mb --ignore-existing myminio/cd-logs
          .\mc.exe ls myminio
          Write-Host "[OK] MinIO bucket ready"

      - name: Collect logs
        if: always()
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Collecting logs..."
          New-Item -ItemType Directory -Force -Path logs | Out-Null

          $containers = @("app", "db", "minio")

          foreach ($container in $containers) {
            Write-Host "`n=== Collecting logs for $container ==="
            try {
              $logs = docker logs $container --tail=200 2>&1
              $logs | Out-File -FilePath "logs/${container}.log" -Encoding UTF8 -Force
              Write-Host "âœ“ Successfully collected logs for $container"
              Write-Host $logs
            } catch {
              Write-Host "[WARNING] Failed to collect logs for $container: $_"
            }
          }

          Write-Host "`n========================================`n"
          Write-Host "APP LOGS:"
          Write-Host "========================================`n"
          if (Test-Path "logs/app.log") {
            Get-Content "logs/app.log"
          } else {
            Write-Host "app.log not found"
          }

          Write-Host "`n========================================`n"
          Write-Host "DATABASE LOGS:"
          Write-Host "========================================`n"
          if (Test-Path "logs/db.log") {
            Get-Content "logs/db.log" | Select-Object -Last 100
          }

          Write-Host "`n========================================`n"
          Write-Host "MINIO LOGS:"
          Write-Host "========================================`n"
          if (Test-Path "logs/minio.log") {
            Get-Content "logs/minio.log" | Select-Object -Last 50
          }

          Write-Host "`n========================================`n"
          Write-Host "Files collected:"
          Get-ChildItem logs/ | Format-Table
          exit 0

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Display service status
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "Service Status:"
          Write-Host "========================================"
          docker compose ps
          Write-Host ""
          Write-Host "========================================"
          Write-Host "Access URLs:"
          Write-Host "  MinIO Console: http://localhost:9001"
          Write-Host "  Database: localhost:5432"
          Write-Host "========================================"

      - name: Teardown services
        if: failure()
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Stopping and removing services (on failure)..."
          docker compose down --remove-orphans --volumes
          Write-Host "[OK] Teardown complete"

      - name: Services deployed successfully
        if: success()
        shell: powershell
        run: |
          Write-Host "[OK] Services deployed and running!"
          docker compose ps

      - name: Show service logs
        if: always()
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "`n=== DOCKER COMPOSE STATUS ==="
          docker compose ps -a

          Write-Host "`n=== APP CONTAINER LOGS ==="
          docker logs app --tail=100

          Write-Host "`n=== DB CONTAINER LOGS ==="
          docker logs db --tail=50

          Write-Host "`n=== MINIO CONTAINER LOGS ==="
          docker logs minio --tail=50

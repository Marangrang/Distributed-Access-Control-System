name: CD - Build and Deploy Locally

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 180
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create compose .env from secrets
        shell: powershell
        run: |
          @"
          DB_NAME=${{ secrets.DB_NAME || 'face_verification_db' }}
          DB_USER=${{ secrets.DB_USER || 'NWUUSER' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD || 'mypassword' }}
          MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER || 'minioadmin' }}
          MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD || 'minioadmin' }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY || 'minioadmin' }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY || 'minioadmin' }}
          UVICORN_PORT=8000
          "@ | Out-File -FilePath .env -Encoding utf8

      - name: Create serve/.env from secrets
        shell: powershell
        run: |
          @"
          APP_ENV=production
          APP_DEBUG=false
          LOG_LEVEL=info
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=${{ secrets.DB_NAME || 'face_verification_db' }}
          DB_USER=${{ secrets.DB_USER || 'NWUUSER' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD || 'mypassword' }}
          MINIO_ENDPOINT=http://minio:9000
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY || 'minioadmin' }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY || 'minioadmin' }}
          MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER || 'minioadmin' }}
          MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD || 'minioadmin' }}
          MINIO_BUCKET=faiss-index
          MINIO_REGION=us-east-1
          SIMILARITY_THRESHOLD=0.7
          FAISS_INDEX_PATH=verification_service/faiss_index/driver_vectors.index
          METADATA_PATH=verification_service/faiss_index/metadata.json
          EMBED_DIM=512
          K_NEIGHBORS=5
          UVICORN_WORKERS=2
          UVICORN_PORT=8000
          DATA_DIR=/opt/face-verification/data
          LOG_DIR=/opt/face-verification/logs
          "@ | Out-File -FilePath serve\.env -Encoding utf8

      - name: Ensure Docker Desktop is up
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          docker context use desktop-linux | Out-Null
          $deadline = (Get-Date).AddMinutes(3)
          do {
            Start-Sleep -Seconds 5
            try { docker version | Out-Null; $ok = $true } catch { $ok = $false }
          } while ((-not $ok) -and (Get-Date) -lt $deadline)
          if (-not $ok) { Write-Host 'ERROR: Docker daemon not ready'; exit 1 }

      - name: Verify Docker
        shell: powershell
        run: |
          Write-Host "Docker version:"
          docker version
          Write-Host "`nDocker info:"
          docker info

      - name: Optional pre-clean
        shell: powershell
        continue-on-error: true
        run: |
          docker compose down -v
          docker system prune -f

      - name: Fail if compose file missing
        shell: powershell
        run: |
          if (-not ((Test-Path '.\docker-compose.yml') -or (Test-Path '.\docker-compose.yaml'))) {
            Write-Host "docker-compose.yml or docker-compose.yaml not found"
            exit 1
          }

      - name: Build Docker image with cache
        shell: powershell
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker compose build --progress=plain

      - name: Deploy Application
        shell: powershell
        run: |
          docker compose up -d
          docker compose ps

      - name: Health check
        shell: powershell
        run: |
          $deadline = (Get-Date).AddMinutes(3)
          $ok = $false
          while (-not $ok -and (Get-Date) -lt $deadline) {
            try {
              $res = Invoke-RestMethod -Uri "http://localhost:8080/health" -TimeoutSec 5
              if ($res.status -eq 'ok' -or $res -eq 'ok') { $ok = $true }
            } catch { Start-Sleep -Seconds 5 }
          }
          if (-not $ok) { Write-Host "Health check failed"; docker compose logs app; exit 1 }

      - name: Collect logs
        if: always()
        shell: powershell
        run: |
            mkdir -Force logs | Out-Null
            docker compose logs --no-color > logs\compose.log 2>&1
            docker compose logs app --no-color > logs\app.log 2>&1
            docker compose logs db --no-color > logs\db.log 2>&1
            docker compose logs minio --no-color > logs\minio.log 2>&1
            docker ps -a > logs\ps-a.txt
            docker info > logs\docker-info.txt
            docker compose config > logs\compose-config.txt

      - name: Cleanup
        if: always() 
        shell: powershell
        run: |
          # Stop and remove all containers
          docker compose down -v
          # Optionally, remove unused images and volumes
          docker system prune -f

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: logs
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          include-hidden-files: false
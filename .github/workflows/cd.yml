name: CD - Build, Publish and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        shell: powershell
        run: |
          echo "${{ secrets.GHCR_PUSH_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image
        shell: powershell
        run: |
          $IMAGE = "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}".ToLower()
          $TAG_LATEST = "${IMAGE}:latest"
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          $TAG_SHA = "${IMAGE}:main-${SHORT_SHA}"
          
          Write-Host "=================================================="
          Write-Host "üî® BUILDING DOCKER IMAGE"
          Write-Host "=================================================="
          Write-Host "Image: $TAG_LATEST"
          Write-Host "Tag:   $TAG_SHA"
          Write-Host ""
          
          docker build -f ./serve/Dockerfile -t $TAG_LATEST -t $TAG_SHA .
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Docker build failed"
            exit 1
          }
          
          Write-Host ""
          Write-Host "üì§ Pushing to GitHub Container Registry..."
          docker push $TAG_LATEST
          docker push $TAG_SHA
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Docker push failed"
            exit 1
          }
          
          Write-Host "‚úÖ Build and push completed"

      - name: Deploy Application Locally
        shell: powershell
        run: |
          Write-Host "=================================================="
          Write-Host "üöÄ DEPLOYING APPLICATION"
          Write-Host "=================================================="
          
          Set-Location "C:\Users\NWUUSER\Documents\deploy SLI\Distributed-Access-Control-System-master"
          
          Write-Host "`nüì• Pulling latest Docker images..."
          docker-compose pull
          
          Write-Host "`nüîÑ Stopping old containers..."
          docker-compose down
          
          Write-Host "`nüöÄ Starting new containers..."
          docker-compose up -d
          
          Write-Host "`n‚è≥ Waiting for containers to be healthy..."
          Start-Sleep -Seconds 10
          
          Write-Host "`nüìä Container status:"
          docker-compose ps
          
          Write-Host "`nüìú Recent logs:"
          docker-compose logs --tail=20
          
          Write-Host "`n=================================================="
          Write-Host "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY"
          Write-Host "=================================================="
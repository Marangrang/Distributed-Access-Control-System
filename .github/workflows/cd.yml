name: CD - Build and Deploy Locally

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Desktop
        shell: powershell
        run: |
          $dockerDesktopPath = "C:\Program Files\Docker\Docker\Docker Desktop.exe"
          
          # Check if Docker Desktop process is running
          $dockerProcess = Get-Process "Docker Desktop" -ErrorAction SilentlyContinue
          
          if (-not $dockerProcess) {
            Write-Host "Starting Docker Desktop..."
            Start-Process "C:\Program Files\Docker\Docker\Docker Desktop.exe"
            
            # Wait for Docker daemon to be ready (max 120 seconds)
            $timeout = 120
            $elapsed = 0
            $ready = $false
            
            while ($elapsed -lt $timeout) {
              Start-Sleep -Seconds 5
              $elapsed += 5
              
              try {
                $null = docker version 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Docker is ready after $elapsed seconds"
                  $ready = $true
                  break
                }
              } catch {
                Write-Host "Waiting for Docker... ($elapsed/$timeout seconds)"
              }
            }
            
            if (-not $ready) {
              Write-Host "ERROR: Docker Desktop failed to start within $timeout seconds"
              exit 1
            }
          } else {
            Write-Host "Docker Desktop is already running"
          }

      - name: Verify Docker
        shell: powershell
        run: |
          Write-Host "Docker version:"
          docker version
          
          Write-Host "`nDocker info:"
          docker info
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Docker verification failed"
            exit 1
          }
          
          Write-Host "`nSUCCESS: Docker is running and accessible"

      - name: Optional pre-clean
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Stopping and removing old containers..."
          docker compose -f docker-compose.yaml down --remove-orphans
          
          Write-Host "Pruning unused Docker resources..."
          docker system prune -f --volumes

      - name: Build Docker image with cache
        shell: powershell
        run: |
          $env:DOCKER_BUILDKIT = "1"
          
          Write-Host "Building Docker image..."
          docker compose -f docker-compose.yaml build --no-cache app
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Docker build failed"
            exit 1
          }

      - name: Deploy Application
        shell: powershell
        run: |
          Write-Host "Starting services..."
          docker compose -f docker-compose.yaml up -d
          
          Write-Host "Waiting for services to be healthy..."
          Start-Sleep -Seconds 30
          
          Write-Host "`nContainer status:"
          docker compose -f docker-compose.yaml ps

      - name: Health check
        shell: powershell
        run: |
          Write-Host "Checking application health..."
          
          $maxAttempts = 12
          $attempt = 0
          $healthy = $false
          
          while ($attempt -lt $maxAttempts) {
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "Application is healthy!"
                $healthy = $true
                break
              }
            } catch {
              Write-Host "Attempt $attempt/$maxAttempts - waiting for app..."
              Start-Sleep -Seconds 10
            }
          }
          
          if (-not $healthy) {
            Write-Host "ERROR: Application failed health check"
            docker compose -f docker-compose.yaml logs app
            exit 1
          }

      - name: Collect logs
        if: always()
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path logs
          docker compose -f docker-compose.yaml logs --no-color > logs/docker-compose.log 2>&1

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_number }}
          path: logs/
          if-no-files-found: warn
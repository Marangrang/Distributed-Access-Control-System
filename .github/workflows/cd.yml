name: CD - Build, Publish and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/marangrang/distributed-access-control-system:latest
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: serve/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          cache-from: |
            type=registry,ref=${{ env.IMAGE_NAME }}
          cache-to: |
            type=registry,ref=${{ env.IMAGE_NAME }},mode=max

  deploy:
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Validate deploy configuration
        run: |
          if [ -z "${{ env.DEPLOY_HOST }}" ] || [ -z "${{ env.DEPLOY_PORT }}" ]; then
            echo "::error::DEPLOY_HOST or DEPLOY_PORT is empty. Check repository secrets."
            exit 1
          fi
          echo "âœ… Deployment target: ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PORT }}"
          timeout 5 nc -zv ${{ env.DEPLOY_HOST }} ${{ env.DEPLOY_PORT }}

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/config << EOF
          Host deployment
          HostName ${{ env.DEPLOY_HOST }}
          Port ${{ env.DEPLOY_PORT }}
          User ${{ env.DEPLOY_USER }}
          StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Verify SSH Connection
        run: |
          echo "ðŸ”— Testing SSH connection with verbose logs..."
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
           echo "Connection attempt $attempt of $max_attempts"
            if ssh -vvv deployment "echo 'SSH connection successful âœ…'"; then
              echo "âœ“ SSH connection verified"
              break
            fi

            if [ $attempt -eq $max_attempts ]; then
              echo "âœ— All connection attempts failed"
              exit 1
            fi

            attempt=$((attempt + 1))
            echo "Retrying in 5 seconds..."
            sleep 5
          done

      - name: Deploy Application
        if: success()
        run: |
          ssh deployment << 'EOF'
            set -e
            echo "ðŸš€ Starting deployment at $(date)"

            if ! docker info >/dev/null 2>&1; then
              echo "âœ— ERROR: Docker is not running"
              exit 1
            fi

            echo "â†’ Pulling latest image..."
            docker pull ghcr.io/marangrang/distributed-access-control-system:latest

            echo "â†’ Stopping and removing old containers..."
            docker compose down --remove-orphans || true

            echo "â†’ Starting new containers..."
            docker compose up -d

            echo "â†’ Verifying deployment..."
            if ! docker compose ps --quiet | grep -q .; then
              echo "âœ— ERROR: No containers running after deployment"
              exit 1
            fi

            echo "âœ“ Deployment completed successfully at $(date)"
            docker compose ps
          EOF

name: CD - Build, Publish and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/marangrang/distributed-access-control-system:latest

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver: docker-container

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: serve/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          cache-from: |
            type=registry,ref=${{ env.IMAGE_NAME }}
          cache-to: |
            type=registry,ref=${{ env.IMAGE_NAME }},mode=max

      - name: Deploy to server via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          cat >> ~/.ssh/config <<EOF
          Host deployment
            HostName ${{ secrets.NGROK_HOST }}
            Port ${{ secrets.NGROK_PORT }}
            User ${{ secrets.DEPLOY_USER }}
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking accept-new
          EOF
          
          echo "ðŸ”— Testing SSH connection..."
          for i in {1..3}; do
            echo "Connection attempt $i of 3"
            if ssh -vvv deployment "echo 'âœ… SSH connected'"; then
              echo "âœ… SSH connection successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              else
                echo "âŒ All connection attempts failed"
                exit 1
              fi
            fi
          done
          
          echo "ðŸš€ Deploying application..."
          ssh deployment "cd ~/deploy\ SLI/Distributed-Access-Control-System-master && docker compose pull && docker compose up -d --force-recreate"
            
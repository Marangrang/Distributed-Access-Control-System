name: CD - Build, Publish and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PUSH_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./serve/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Deploy to server via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          cat > ~/.ssh/config <<EOF
          Host deployment
            HostName ${{ secrets.DEPLOY_HOST }}
            Port ${{ secrets.DEPLOY_PORT }}
            User NWUUSER
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking accept-new
          EOF

          echo "ðŸ”— Testing SSH connection..."
          ssh deployment "echo 'âœ… SSH connected'"

          echo "ðŸš€ Deploying application..."
          ssh deployment 'powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "
            $ErrorActionPreference = ''Stop'';

            function Find-Docker {
              $paths = @(
                ''C:\Program Files\Docker\Docker\resources\bin\docker.exe'',
                (Get-Command docker.exe -ErrorAction SilentlyContinue).Source
              ) | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
              return $paths
            }

            $docker = Find-Docker
            if (-not $docker) {
              Write-Warning ''docker.exe not found. Attempting install via winget.'';
              $winget = (Get-Command winget.exe -ErrorAction SilentlyContinue).Source
              if (-not $winget) {
                Write-Error ''winget not available. Install Docker Desktop manually.''
                exit 1
              }
              try {
                & $winget install -e --id Docker.DockerDesktop --accept-source-agreements --accept-package-agreements
              } catch {
                Write-Error ''winget install failed. Install Docker Desktop manually.''
                exit 1
              }
              Start-Sleep 10
              $docker = Find-Docker
              if (-not $docker) {
                Write-Error ''Docker still not found after install attempt.''
                exit 1
              }
              Write-Host ''Docker executable detected: '' $docker
            }

            Write-Host ''Checking Docker daemon...''
            $maxWait = 60
            for ($i=1; $i -le $maxWait; $i++) {
              try {
                & $docker version *>$null
                $daemonOk = $true
              } catch { $daemonOk = $false }
              if ($daemonOk) { break }
              Start-Sleep 2
            }
            if (-not $daemonOk) {
              Write-Error ''Docker daemon not responding. If Docker Desktop was just installed, log into the machine and start it once.''
              exit 1
            }

            Write-Host ''Logging into GHCR...''
            & $docker login ghcr.io -u ''Marangrang'' -p ''${{ secrets.GHCR_PUSH_TOKEN }}''

            Set-Location ''C:\Users\NWUUSER\Documents\deploy SLI\Distributed-Access-Control-System-master''

            $composeV1 = (Get-Command docker-compose.exe -ErrorAction SilentlyContinue)
            if ($composeV1) {
              Write-Host ''Using docker-compose (v1)''
              & $composeV1.Source pull
              & $composeV1.Source up -d --force-recreate
            } else {
              Write-Host ''Using Docker Compose V2''
              & $docker compose pull
              & $docker compose up -d --force-recreate
            }

            Write-Host ''âœ… Deployment complete''
          "'
name: CD - Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: cd-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: false

env:
  REGISTRY: docker.io
  IMAGE_NAME: distributed-access-control-system-app
  LOG_RETENTION_DAYS: 7

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment
        shell: powershell
        run: |
          Write-Host "Validating environment..." -ForegroundColor Cyan

          $requiredFiles = @(
            "docker-compose.yml",
            "serve/Dockerfile",
            "serve/entrypoint.sh",
            "serve/main.py"
          )

          $missingFiles = @()
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Write-Host "OK $file" -ForegroundColor Green
            } else {
              Write-Host "MISSING $file" -ForegroundColor Red
              $missingFiles += $file
            }
          }

          if ($missingFiles.Count -gt 0) {
            Write-Error "Missing critical files: $($missingFiles -join ', ')"
            exit 1
          }

      - name: Setup Docker
        shell: powershell
        run: |
          Write-Host "Setting up Docker..." -ForegroundColor Cyan

          $maxRetries = 10
          $retryCount = 0

          while ($retryCount -lt $maxRetries) {
            docker ps 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Docker daemon ready" -ForegroundColor Green
              break
            }
            $retryCount++
            if ($retryCount -ge $maxRetries) {
              throw "Docker daemon not responding"
            }
            Write-Host "Waiting for Docker ($retryCount/$maxRetries)..."
            Start-Sleep -Seconds 3
          }

          Write-Host "Docker version:"
          docker --version
          Write-Host "Compose version:"
          docker compose version

      - name: Cleanup old resources
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Cleaning up..." -ForegroundColor Cyan
          docker compose down --remove-orphans --volumes 2>&1 | Out-Null
          docker image prune -f --filter "dangling=true" 2>&1 | Out-Null
          Write-Host "Cleanup complete" -ForegroundColor Green

      - name: Free disk space
        shell: powershell
        run: |
          Write-Host "Freeing disk space..." -ForegroundColor Cyan
          docker system prune -af --volumes
          Get-Volume | Select-Object DriveLetter, SizeRemaining | Format-Table

      - name: Build Docker image
        shell: powershell
        timeout-minutes: 180
        env:
          DOCKER_BUILDKIT: 0
        run: |
          Write-Host "Building Docker image..." -ForegroundColor Cyan

          $maxRetries = 3
          $retryCount = 0
          $buildSuccess = $false

          while ($retryCount -lt $maxRetries -and -not $buildSuccess) {
            $retryCount++
            Write-Host "Build attempt $retryCount of $maxRetries..." -ForegroundColor Yellow

            docker build -t distributed-access-control-system-app:latest -f serve/Dockerfile .

            if ($LASTEXITCODE -eq 0) {
              $buildSuccess = $true
              Write-Host "Build successful" -ForegroundColor Green
            } else {
              Write-Host "Build attempt $retryCount failed" -ForegroundColor Yellow
              if ($retryCount -lt $maxRetries) {
                Write-Host "Waiting 30 seconds before retry..." -ForegroundColor Yellow
                Start-Sleep -Seconds 30
              }
            }
          }

          if (-not $buildSuccess) {
            Write-Error "Docker build failed after $maxRetries attempts"
            exit 1
          }

      - name: Pull pre-built image
        shell: powershell
        run: |
          Write-Host "Pulling pre-built image..." -ForegroundColor Cyan

          # Option A: Pull from Docker Hub (if you pushed it)
          # docker pull yourusername/distributed-access-control-system-app:latest

          # Option B: Load from saved tar file
          # docker load -i app-image.tar

          # For now, use local build on your machine:
          docker images

      - name: Verify images
        shell: powershell
        run: |
          Write-Host "Verifying images..." -ForegroundColor Cyan
          $images = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String "distributed-access-control-system"
          if ($null -eq $images) {
            throw "App image not found"
          }
          Write-Host "Image found: $images" -ForegroundColor Green

      - name: Start services
        shell: powershell
        run: |
          Write-Host "Starting services..." -ForegroundColor Cyan
          docker compose up -d
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to start services"
          }
          Write-Host "Services started" -ForegroundColor Green
          Start-Sleep -Seconds 10

      - name: Wait for health checks
        shell: powershell
        timeout-minutes: 10
        run: |
          Write-Host "Waiting for health checks..." -ForegroundColor Cyan

          $maxAttempts = 120
          $attempt = 0
          $allHealthy = $false

          while ($attempt -lt $maxAttempts) {
            $attempt++

            try {
              $psOutput = docker compose ps --format json

              if ([string]::IsNullOrEmpty($psOutput)) {
                Write-Host "Waiting for containers ($attempt/$maxAttempts)..."
                Start-Sleep -Seconds 5
                continue
              }

              $containers = $psOutput | ConvertFrom-Json -ErrorAction Stop
              if ($containers -isnot [array]) {
                $containers = @($containers)
              }

              $app = $containers | Where-Object { $_.Service -eq "app" }
              $db = $containers | Where-Object { $_.Service -eq "db" }
              $minio = $containers | Where-Object { $_.Service -eq "minio" }

              if ($app -and $db -and $minio) {
                Write-Host "Status: app=$($app.State) db=$($db.State) minio=$($minio.State)"

                if ($app.State -match "healthy" -and $db.State -match "healthy" -and $minio.State -match "running|healthy") {
                  Write-Host "All services healthy" -ForegroundColor Green
                  $allHealthy = $true
                  break
                }
              }
            } catch {
              Write-Host "Health check error: $($_.Exception.Message)"
            }

            Start-Sleep -Seconds 5
          }

          if (-not $allHealthy) {
            Write-Host "Services failed to become healthy" -ForegroundColor Red
            docker compose ps
            docker logs app --tail=100
            exit 1
          }

      - name: Smoke tests
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Running smoke tests..." -ForegroundColor Cyan

          Write-Host "Test 1: API Health"
          try {
            $resp = Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing -TimeoutSec 5
            if ($resp.StatusCode -eq 200) {
              Write-Host "API healthy" -ForegroundColor Green
            }
          } catch {
            Write-Host "API test failed: $_" -ForegroundColor Yellow
          }

          Write-Host "Test 2: Database"
          docker compose exec -T db pg_isready -U NWUUSER -d face_verification_db

          Write-Host "Test 3: MinIO"
          try {
            Invoke-WebRequest -Uri "http://localhost:9000/minio/health/live" -UseBasicParsing -TimeoutSec 5 | Out-Null
            Write-Host "MinIO healthy" -ForegroundColor Green
          } catch {
            Write-Host "MinIO test failed" -ForegroundColor Yellow
          }

      - name: Collect logs
        if: always()
        shell: powershell
        run: |
          Write-Host "Collecting logs..." -ForegroundColor Cyan
          New-Item -ItemType Directory -Force -Path logs | Out-Null

          @("app", "db", "minio") | ForEach-Object {
            $service = $_
            Write-Host "Saving $service logs..."
            docker logs $service --tail=300 --timestamps 2>&1 | Out-File -FilePath "logs/$service.log" -Encoding UTF8 -Force
          }

          docker compose ps --format json 2>&1 | Out-File -FilePath "logs/docker-status.json" -Encoding UTF8 -Force

          Write-Host "Log files:"
          Get-ChildItem logs/ | Format-Table Name, Length

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: warn

      - name: Summary
        if: always()
        shell: powershell
        run: |
          Write-Host "Deployment Summary" -ForegroundColor Cyan
          Write-Host "Status: ${{ job.status }}"
          docker compose ps

      - name: Cleanup on failure
        if: failure()
        shell: powershell
        run: |
          Write-Host "Collecting failure diagnostics..." -ForegroundColor Yellow
          docker compose logs --tail=100
          docker compose logs --tail=100
          docker system df
